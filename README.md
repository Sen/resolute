# Resolute

A DNS proxy with DoH/DoT support, EDNS Client Subnet, and GeoIP-based routing.

> ⚠️ **Disclaimer**: This project is generated by AI (Claude), including code, configuration, and documentation.

## Features

- **DNS over HTTPS (DoH)** - Encrypted DNS queries
- **DNS over TLS (DoT)** - Alternative encrypted DNS protocol
- **EDNS Client Subnet** - Pass client IP for better CDN routing
- **GeoIP Routing** - Route queries based on IP geolocation
- **Domain Rules** - Support for v2fly/domain-list-community
- **Proxy Support** - HTTP/HTTPS/SOCKS5 proxy for DNS forwarding
- **DNS Caching** - Reduce latency and upstream load
- **Cross-platform** - Linux, macOS, Windows

## Installation

### Download from Releases

Go to the [Releases](../../releases) page and download the binary for your platform.

### Build from Source

```bash
# Requires Rust 1.75+
cargo build --release
```

## Usage

```bash
# Use default config file (config.toml)
./resolute

# Specify config file
./resolute -c /path/to/config.toml

# Show help
./resolute --help
```

## Configuration

Copy `config.example.toml` to `config.toml` and customize:

```bash
cp config.example.toml config.toml
```

### Basic Configuration

```toml
[server]
listen = "127.0.0.1:5353"  # Listen address
log_level = "info"          # Log level

[geoip]
url = "https://github.com/Loyalsoldier/geoip/releases/latest/download/Country.mmdb"
update_interval_hours = 24

[cache]
enabled = true
max_entries = 10000
```

### Upstream DNS

```toml
# International DNS (via proxy)
[upstreams.cloudflare]
type = "doh"
url = "https://1.1.1.1/dns-query"
proxy = "us"
edns_client_ip = "proxy"

# Domestic DNS (direct)
[upstreams.alidns]
type = "doh"
url = "https://223.5.5.5/dns-query"
edns_client_ip = "local"
```

### Proxy Configuration

```toml
[proxies.us]
url = "socks5://127.0.0.1:1080"
outbound_ip = "1.2.3.4"  # Proxy egress IP for EDNS
```

### Routing Rules

```toml
# China domains -> domestic DNS
[[rules]]
domain_list = ["cn"]
upstream = "alidns"

# Foreign domains -> international DNS
[[rules]]
domain_list = ["geolocation-!cn"]
upstream = "cloudflare"

# Default fallback
[default]
upstream = "alidns"
```

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        Client                               │
│                    (UDP/TCP :5353)                          │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                      DNS Server                             │
│                  (hickory-server)                           │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                       Router                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ DNS Cache   │  │ Domain List │  │ Routing Rules       │  │
│  │ (moka)      │  │ (v2fly)     │  │ (domain/geoip)      │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────┬───────────────────────────────────────┘
                      │
          ┌───────────┼───────────┐
          ▼           ▼           ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│  Upstream   │ │  Upstream   │ │  Upstream   │
│ (Cloudflare)│ │  (Google)   │ │  (AliDNS)   │
│    DoH      │ │    DoH      │ │    DoH      │
└──────┬──────┘ └──────┬──────┘ └─────────────┘
       │               │              │
       ▼               ▼              │
┌─────────────┐ ┌─────────────┐       │
│   Proxy     │ │   Proxy     │       │
│   (SOCKS5)  │ │   (HTTP)    │       │
└─────────────┘ └─────────────┘       │
       │               │              │
       └───────────────┴──────────────┘
                       │
                       ▼
                   Internet
```

### Core Components

| Component | Description |
|-----------|-------------|
| `server` | DNS server, listens on UDP/TCP |
| `router` | Routing engine, selects upstream based on rules |
| `upstream` | Upstream DNS client (DoH/DoT) |
| `cache` | DNS response cache (moka) |
| `domain_list` | v2fly domain list parser |
| `geoip` | MaxMind GeoIP lookup |
| `edns` | EDNS Client Subnet handling |

### Tech Stack

- **Rust** - Systems programming language
- **Tokio** - Async runtime
- **hickory-dns** - DNS protocol implementation
- **reqwest** - HTTP client (DoH)
- **rustls** - TLS implementation
- **moka** - High-performance cache
- **maxminddb** - GeoIP database

## License

MIT
